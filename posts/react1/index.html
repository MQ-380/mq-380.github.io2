<!DOCTYPE html><html lang="en" > <!-- The Head v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>React与它的小伙伴们（1）—— React | Subaru</title><meta name="generator" content="Jekyll v4.1.1" /><meta property="og:title" content="React与它的小伙伴们（1）—— React" /><meta name="author" content="Subaru" /><meta property="og:locale" content="en_US" /><meta name="description" content="几个月前，机缘巧合，跟着几篇博文对于React、Redux等技术做了一些更深层次的了解。在此，特别整理一下汇整成笔记。" /><meta property="og:description" content="几个月前，机缘巧合，跟着几篇博文对于React、Redux等技术做了一些更深层次的了解。在此，特别整理一下汇整成笔记。" /><link rel="canonical" href="https://mqsh.me/posts/react1/" /><meta property="og:url" content="https://mqsh.me/posts/react1/" /><meta property="og:site_name" content="Subaru" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-11-21T01:40:36+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="React与它的小伙伴们（1）—— React" /><meta name="twitter:site" content="@MQ380" /><meta name="twitter:creator" content="@Subaru" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"几个月前，机缘巧合，跟着几篇博文对于React、Redux等技术做了一些更深层次的了解。在此，特别整理一下汇整成笔记。","dateModified":"2020-11-21T01:40:36+08:00","datePublished":"2020-11-21T01:40:36+08:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://mqsh.me/posts/react1/"},"url":"https://mqsh.me/posts/react1/","author":{"@type":"Person","name":"Subaru"},"headline":"React与它的小伙伴们（1）—— React","@context":"https://schema.org"}</script> <!-- The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps Generated by: https://www.favicon-generator.org/ v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT license --><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" as="style" href="/assets/css/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/main.css"><link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"><link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/popper.js@1.15.0/dist/umd/popper.min.js" integrity="sha256-fTuUgtT7O2rqoImwjrhDgbXTKUwyxxujIMRIK7TbuNU=" crossorigin> <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script> <script> window.jQuery || document.write('<script src="/assets/lib/jquery-3.4.1.min.js"><\/script>'); </script> <script src="https://cdn.jsdelivr.net/npm/popper.js@1.15.0/dist/umd/popper.min.js" integrity="sha256-fTuUgtT7O2rqoImwjrhDgbXTKUwyxxujIMRIK7TbuNU=" crossorigin="anonymous" async></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha256-5+02zu5UULQkO7w1GIr6vftCgMfFdZcAHeDtFnKZsBs=" crossorigin="anonymous" async></script> <script src="/assets/js/dist/commons.js" async></script> <script src="/assets/js/dist/timeago.min.js" async></script><link rel="preload" as="style" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/syntax.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/syntax.css"><link rel="preload" as="style" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.css"><link rel="preload" as="script" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.js"><link rel="stylesheet" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.css" /> <script src="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.js" async></script> <script src="/assets/js/dist/toc.min.js" async></script> <script src="/assets/js/dist/tooltip-loader.min.js" async></script> <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"> <!-- The Side Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/poe.jpg" alt="avatar"> </a></div><div class="profile-text mt-3"><div id="site-title"> <a href="/">Subaru</a></div><div id="site-subtitle" class="font-italic">FE Engnieer</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-3 mr-3 unloaded"></i> <span>HOME</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-3 mr-3 unloaded"></i> <span>CATEGORIES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-3 mr-3 unloaded"></i> <span>ARCHIVES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-3 mr-3 unloaded"></i> <span>ABOUT</span> </a></li></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <span id="mode-toggle-wrapper"> <!-- Switch the mode between dark and light. v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <i class="mode-toggle fas fa-sun" light-mode-invisible></i> <i class="mode-toggle fas fa-moon" dark-mode-invisible></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.mode != null) { if (this.mode == ModeToggle.DARK_MODE) { if (!this.isDarkPrefer) { this.setDark(); } } else { if (this.isDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.mode != null) { if (self.mode == ModeToggle.DARK_MODE) { if (!self.isDarkPrefer) { self.setDark(); } } else { if (self.isDarkPrefer) { self.setLight(); } } self.clearMode(); } }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isDarkPrefer() { return this.sysDarkPrefers.matches; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } flipMode() { if ((this.mode == null && this.isDarkPrefer) || this.mode == ModeToggle.DARK_MODE) { this.setLight(); } else { /* light mode or default-light */ this.setDark(); } } } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> <span class="icon-border"></span> <a href="https://github.com/mq-380" target="_blank"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/MQ380" target="_blank"> <i class="fab fa-twitter"></i> </a> <a href="javascript:window.open('mailto:' + ['shmao288','gmail.com'].join('@'))"> <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" target="_blank"> <i class="fas fa-rss"></i> </a></div></div><div id="main-wrapper"> <!-- The Top Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>React与它的小伙伴们（1）—— React</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main"> <!-- Fixed kramdown code highlight rendering: https://github.com/penibelst/jekyll-compress-html/issues/101 https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901 --><div class="progress" style=""><div class="progress-bar" id="progress" role="progressbar" style="width: 0%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div></div><div class="row" id='article_wrapper'><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>React与它的小伙伴们（1）—— React</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago" data-toggle="tooltip" data-placement="bottom" title="Sat, Nov 21, 2020, 1:40 AM +0800"> Nov 21, 2020 <i class="unloaded">2020-11-21T01:40:36+08:00</i> </span> on <a href='/categories/%E6%8A%80%E6%9C%AF/'>技术</a></div></div><div class="post-content" id='post-content'><p>几个月前，机缘巧合，跟着几篇博文对于React、Redux等技术做了一些更深层次的了解。在此，特别整理一下汇整成笔记。</p><p>前人之述备矣，这里也仅仅只是汇整，所以大佬们可以跳过啦。当然也欢迎挑刺问题。不正之处，敬请指出。~</p><p>一天肯定是写不完了，还是分系列完成吧。今天是第一部分。</p><h2 id="react">React</h2><p>首先，从React开始。React作为一个当前流行的前端框架，从使用上，API的调用，生命周期的流转，作为一名前端工程师来说相信都是十分了解和完备的了。但有时候确实也会想要钻研一下，内部的实现逻辑。这时候就要去看看源代码啦~。</p><p>（下面的内容，主要为这篇文章的摘要笔记，基本省去了看代码的环节，详情可参考这篇好文 -&gt; <a href="https://react.iamkasong.com/">React技术揭秘</a>（文章内容已经比我几个月前看要详细不少了））</p><h3 id="react的设计理念">React的设计理念</h3><p>七个字就能概括，<strong>速度快，响应自然</strong>。当然如果从数学的角度来看，也就是一个y=f(x)的对应关系。视图y根据状态x的变化而变化。从jQuery直接操控DOM的方式解放出来。 个人理解，其实说到底React所做的就是完成y=f(x)中f的变化映射关系。也就是把想要的视图和所拿到的数据进行连接的工作。</p><h3 id="react架构的演变历程--v15之前">React架构的演变历程 —— V15之前</h3><p>在ReactV15版本重构之前的架构可以一览如下。</p><p>Reconciler（协调器）-&gt; 找出变化的组件 Renderer（渲染器）-&gt; 将变化的组件渲染到页面上</p><p>流程为： 用户出发update =&gt; Reconciler =&gt; Renderer</p><p>接下来，就来详细看一下这两个组件干了些什么，以及为什么会被重构的原因。</p><h4 id="构成">构成</h4><ol><li><p>Reconciler： 当有更新发生时（this.setState、forceUpdate、render等可出发），这个部分组件完成以下工作： a. 调用函数组件，或class的render方法，将返回的JSX内容转化为虚拟DOM结构。 b. 对比上一次生成的DOM结构 c. 找出要被更新的DOM结构 d. 通知renderer组件更新到页面上。</p></li><li><p>Renderer： 这部分其实根据React运行环境的不同，React将其拆分出了几个部分。如果宿主为浏览器，那么进行这部分工作的为ReactDOM，App原生组件的话是ReactNative，如果为测试环境或者canvas环境也有着各自的渲染组件。这些渲染组件的存在，使得React可以用同一套理念进行不一样端的渲染，减少开发的工作量。</p></li></ol><p>这个部分的作用其实就一句话，接收上一层Reconciler的通知，把视图更新到宿主环境即可。</p><h4 id="此架构的缺点">此架构的缺点</h4><p>Reconciler中，被mount的组件会调用mountComponent、被Update的组件会调用updateComponent，这样产生的后果就是会递归更新子组件。递归更新子组件的话，因为大多显示器的展示帧率为60Hz，且JS的计算运行线层与渲染视图是互斥的，那么递归深度过沈的话，就会导致部分UI的更新不完全，产生业务上不必要的困扰。</p><p>那么新的架构是如何解决这个问题的呢？</p><h3 id="react架构的演变历程--v16及之后">React架构的演变历程 —— V16及之后</h3><p>新的架构引入了一个新的组件，称之为Scheduler（调度器），顾名思义，这个是用来调度任务的优先级的组件。</p><p>其余的两个部分还是和之前的一样，是Reconciler和Renderer。</p><h4 id="构成-1">构成</h4><p>那么主要来看一下这三个部分分别做了些什么事情。 首先是新引入的Scheduler组件。</p><ol><li><p>Scheduler： 主要任务就是判断当前更新工作的优先级，进行调度。 部分浏览器已经实现了一种名为requestIdleCallback的机制，来让我们可以从浏览器知道是否有剩余时间作为任务中断的标准。但是，虽然部分浏览器已经有这个回调函数功能，但是因为兼容性以及触发概率不稳定等原因，React并没有采取这个，而是亲自实现了这个可以独立于整个React框架使用的Scheduler库。</p></li><li><p>Reconciler 协调器当然也有变化。根据之前版本的痛点，把更新的过程，从递归变化了可中断的循环过程。每次循环都会以调用shouldYield作为标准来判断当前是否有剩余时间。</p></li></ol><p>那么React16是如何解决中断更新时DOM渲染不完全的问题呢？ 在React16中，<strong>Reconciler</strong>与<strong>Renderer</strong>不再是交替工作。当<strong>Scheduler</strong>将任务交给<strong>Reconciler</strong>后，<strong>Reconciler</strong>会为变化的虚拟DOM打上代表增_删_更新的标记。只有当所有组件都完成了Reconciler，才会将其交给下一步的render。所以，如果上一个渲染被高优先级任务打断了，那么这个被打断的流程也不会走到render上，让用户看到错误的数据。</p><p><strong>这个部分中采用了Fiber架构</strong></p><ol><li>Renderer 这个部分并没有什么过多的变化，同样是根据上一步给出的虚拟DOM标记，同步执行用户界面的渲染工作。</li></ol><h3 id="fiber">Fiber</h3><p>Fiber何许人也？也就是React16之后内部的虚拟DOM结构。 为什么要有Fiber？ 因为之前的虚拟DOM结构适用于递归寻找更新，由于递归有可能很深，造成用户界面卡顿，所以转化了为了循环。为了适应这个可中断循环，那么就要对内部的虚拟DOM结构进行改造。</p><ol><li><p>作为静态的数据结构来说，每个Fiber节点对应一个React element，保存了该组件的类型（函数组件_类组件_原生组件…）、对应的DOM节点等信息。</p></li><li><p>作为动态的工作单元来说，每个Fiber节点保存了本次更新中该组件改变的状态、要执行的工作（需要被删除_被插入页面中_被更新…）。</p></li></ol><h4 id="fiber树的双缓存">Fiber树的双缓存</h4><p>双缓存？ <strong>在内存中构建并直接替换</strong>的技术叫做 <a href="https://baike.baidu.com/item/%E5%8F%8C%E7%BC%93%E5%86%B2">双缓存 </a> <a href="https://baike.baidu.com/item/%E5%8F%8C%E7%BC%93%E5%86%B2">(opens new window)</a> 。React使用“双缓存”来完成Fiber树的构建与替换——对应着DOM树的创建与更新。 React在构建中最多同时有两棵Fiber树，一个对应着当前的视图结构（current Fiber），一个对应着之后将要变化到的结构，也就是正在构建中的（workInProgress Fiber）。 每次状态更新都会产生新的workInProgress Fiber树 ，通过current 与workInProgress的替换，完成DOM更新。</p><h4 id="fiber树的构建替换流程">Fiber树的构建替换流程</h4><p>这里考虑的是这个简单的React组件。</p><div class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>
<span class="kd">function</span> <span class="nx">App</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">num</span><span class="p">,</span> <span class="nx">add</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="o">&lt;</span><span class="nx">p</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="o">=&gt;</span> <span class="nx">add</span><span class="p">(</span><span class="nx">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)}</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">num</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/p</span><span class="err">&gt;
</span>  <span class="p">)</span>
<span class="p">}</span>

<span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="o">&lt;</span><span class="nx">App</span><span class="o">/&gt;</span><span class="p">,</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">root</span><span class="dl">'</span><span class="p">));</span>

</pre></table></code></div></div><p><strong>Render时</strong></p><ol><li>首次执行ReactDOM.render时，会创建一个fiberRootNode和rootFiber。其中前者是整个应用的根节点而rootFiber是<App></App>所在组件树的根节点。 Why区分？因为应用中可以多次调用ReactDOM.render来渲染不同的组件树，但是整个应用的根节点只会有一个。</li></ol><p>那么fiberRootNode的current指针就会指向当前已经渲染内容的Fiber树，这个就被称为current Fiber树。</p><ol><li><p>接下来进入render阶段。根据组件返回的JSX在内存中创建Fiber树，并且构建成workInProgress树，这个树会尝试复用current中的Fiber元素，作为alternate的智者。</p></li><li><p>构建完成的workInProgress Fiber树将会在commit阶段渲染到页面中。</p></li></ol><p><strong>Update时</strong></p><ol><li><p>用户触发了改变，这样会启动一个render阶段并构建新的workInProgress树。和amount时候一样，这个fiber的创建可以复用数据，也就是alternate的节点。 （判断是否可以复用，就要用到之后的diff算法）</p></li><li><p>workInProgress树在render阶段完成以后在commit之后渲染到页面上，同时变为current树。</p></li></ol><p>大致的流程就是如此，那么每个Fiber节点是如何创建的呢？请继续往下。</p><h3 id="react构建fiber树render阶段">React构建Fiber树（render阶段）</h3><p>React构建Fiber树是通过<strong>深度优先遍历</strong>进行的。主要的流程是： beginWork =&gt; reconcileChildren =&gt; completeWork （根据深度优先遍历进行迭代，直至最终结束）</p><h4 id="beginwork">beginWork</h4><p>该方法根据传入的Fiber节点创建子节点，并将这两个节点连接起来。这个方法的三个参数为：current，workInProgress以及renderLanes。作用分别为对应节点上一渲染的结果，当前组件对应的Fiber节点以及优先级相关内容。 并且可以通过current是否为null来进行区分是mount阶段还是update阶段。</p><p>这两者的区别在于，如果是update，那么就可以尝试复用current来优化，克隆current.child作为workInProgress.child，而不需要重新创建。而mount时候则根据不同的fiber.tag来创建不一样的子fiber节点。</p><p>update时候有两种情况可以直接使用：</p><ol><li>oldProps === newProps &amp;&amp; workInProgress.type === current.type， 即props与fiber.type 不变</li><li>!includesSomeLane(renderLanes, updateLanes) ，即当前Fiber节点优先级不够。</li></ol><p>mount时，也就是当不满足优化路径是，则要新建子Fiber（fiber.stateNode === nul，且接下来的步骤中不会赋值effectTag，而根节点拥有）。</p><p>根据不一样的Fiber类型（FunctionComponent，ClassComponent， HostComponent），进入到最核心的reconcileChildren方法。</p><h3 id="reconcilechildren">reconcileChildren</h3><p>对于mount来的，创建新子Fiber节点。 对于update来的，进行diff算法，对应比较上次的Fiber和这次的更新，将比较的结果生成Fiber子节点。 无论是哪一种方式，都会生成新的子节点作为本次beginWork的返回值，作为下次workInProgress的传参。</p><p>通知Renderer进行更新的两个条件：</p><ol><li>fiber.stateNode存在。</li><li>fiber.effectTag存在。 何为effectTag？ effectTag就是用来告诉renderer执行DOM操作的具体类型。利用二进制数据表示。 那么既然mount阶段没有stateNode和effectTag，首屏渲染的完成是如何完成的呢？其中fiber.stateNode将会在之后的completeWork中创建。而后一个effectTag的问题，mount时候只有第一个root结点会有effectTag，那么整个树只要在执行一次插入的DOM操作即可。</li></ol><h3 id="completework">completeWork</h3><p>这个部分接收三个参数，和beginWork同样，并且针对不同类型的fiber会有这不同的处理逻辑。</p><p>这里的主要工作分别是处理一些props内容，并且对已经存在Fiber结点进行一些更新处理或者回调函数的注册。</p><h3 id="effectlist">effectList</h3><p>其实整个render阶段的工作已经接近完成了。那么在之后commit阶段如何避免再次对Fiber树进行递归寻找effectTag不为null的节点呢？ 这里，React在completeWork的上层方法completeUnitOfWork中，每个执行完成的completeWork且存在effectTag的Fiber节点会被保存在effectList的<strong>单向链表</strong>中。那么之后的阶段只要对这个链表进行遍历就可以执行完所有的effect了。</p><blockquote><p>借用React团队成员<strong>Dan Abramov</strong>的话：effectList相较于Fiber树，就像圣诞树上挂的那一串彩灯。</p></blockquote><h3 id="react进行渲染commit阶段">React进行渲染（commit阶段）</h3><p>commit阶段的起点，就是调用commitRoot方法，并且传参root这个结点。 这个里面包含了rootFiber.firstEffect，也就是上面提到的单向链表的起点。</p><p>在commit阶段做的工作是副作用对应的DOM操作，部分DId系列生命周期钩子以及hook的useEffect都需要在这个阶段进行执行。</p><p>那么整个commit阶段分为三个部分，分别是before mutation（执行DOM操作前）、mutation（执行DOM操作）、layout（执行DOM操作之后）</p><p>在before之前和layout之后其实还有一些例如useEffect的出发，优先级相关的充值以及ref的绑定等。</p><h4 id="before-mutation之前">before mutation之前</h4><p>主要完成一些变量赋值，状态重置的工作。主要还是最后的firstEffect的赋值。</p><h4 id="layout之后">layout之后</h4><p>包含三点内容: useEffect的处理、性能追踪相关以及生命周期钩子函数的触发。</p><h4 id="before-mutation">before mutation</h4><p>概述就是遍历effectList，并调用commitBefore MutationEffects方法进行处理。 这个方法大致可以分为三个部分：</p><ol><li>处理DOM节点渲染、删除之后的autoFocus和blur逻辑</li><li>调用getSnapshotBeforeUpdate生命周期钩子 这里提出的问题，为什么在重构之后，will系列的生命周期加上了UNSAFE前缀。主要原因就是前一个render阶段可能会中断或者重新开始，那么在render阶段调用的will系列生命周期钩子就有可能触发多次。为了解决这个问题，React给出了getSnapshotBeforeUpdate。在commit阶段进行调用因为是同步的就可以避免多次调用的问题。</li><li>调度useEffect（流程有点复杂，可以参考原文 -&gt; <a href="https://react.iamkasong.com/renderer/beforeMutation.html#%E8%B0%83%E5%BA%A6useeffect">React技术揭秘</a>） useEffect的调用是异步的。 为什么要异步？<blockquote><p>与 componentDidMount、componentDidUpdate 不同的是，在浏览器完成布局与绘制之后，传给 useEffect 的函数会延迟调用。这使得它适用于许多常见的副作用场景，比如设置订阅和事件处理等情况，因此不应在函数中执行阻塞浏览器更新屏幕的操作。</p></blockquote></li></ol><p>可见，useEffect异步执行的原因主要是防止同步执行时阻塞浏览器渲染。</p><h4 id="mutation">mutation</h4><p>同样是遍历effectList链表，并执行commitMutationEffects方法，主要进行了三个操作：</p><ol><li>根据ContentReset effectTag重置文字结点</li><li>更新ref</li><li>根据effectTag分别处理（DOM的增删改等操作）</li></ol><p>effectTag的处理主要是以下几种</p><ol><li>Placement类型： 该Fiber结点对应的DOM结点，需要插入到页面中，首先获取父级DOM结点，其次获取兄弟DOM结点，最后根据DOM兄弟结点是否存在来决定是否调用parentNode insertBefore或者parentNode.appendChild来进行DOM的插入操作。</li><li>update类型： 说明该Fiber结点需要更新。根据fiber.tag分别处理。 Function的话调用useLayoutEffect这个hook的销毁函数（return出来的函数）。 Host类型的话就调用commitUpdate</li><li>deletion类型：需要从DOM中删除，调用的方法是commitDeletion。 做的操作是递归调用Fiber结点和子孙结点中fiber.tag为ClassComponent的componentWillUnmount生命周期，并且从页面中移除DOM，其次解绑ref，最后调用useEffect的销毁函数。</li></ol><h4 id="layout阶段">layout阶段</h4><p>该阶段触发的生命周期函数以及hook已经可以访问到改变之后的DOM了。 layout阶段同样需要遍历effectList，这里执行的就是commitLayoutEffect方法了。主要做了两件事</p><ol><li>commitLayoutEffectOnFiber（调用生命周期钩子和hook的相关操作） 对于Class组件，会通过current是否为null来决定调用DIdMount或者是DidUpdate. setState的第二个回调函数参数，也会在这里被调用（所以里面拿到的state数据已经是新的了） 对于Function的组件，会调用useLayoutEffect的回调函数，调度useEffect的销毁与回调函数，useEffect将会在layout结束以后异步执行。 对于HostRoot，如果有第三个回调函数，也会在这时候被执行。</li><li>commitAttachRef（赋值ref） 这个很简单，获取DOM实例，并且绑定到ref上</li></ol><p>最后，双缓存机制需要把结束的工作挂载到current上。</p><p>而root.current = finishedWork 这行代码是在mutation结束后，layout前执行的。 Why? 我们知道componentWillUnmount会在mutation阶段执行。此时current Fiber树还指向前一次更新的Fiber树 ，在生命周期钩子内获取的DOM还是更新前的。 componentDidMount和componentDidUpdate会在layout阶段执行。此时 current Fiber树已经指向更新后的Fiber树，在生命周期钩子内获取的 DOM## 就是更新后的。</p><p>最后的总结，其实commit的三个阶段就是在三次遍历上一个render阶段生成的effectList，并且根据这个list来对DOM进行操作，将数据驱动到视图上。这个effectList的生成，其实规避了commit阶段三次对Fiber树的遍历，优化了性能。</p><h3 id="diff算法">DIff算法</h3><p>这里只简单概述。 这里需要完成的内容就是DOM结点是否可以复用的问题。 根据Fiber的children的类型不同可以分为单节点diff和多节点diff 主要的流程： 1 看key是否相同 2 key不同，直接不复用。 3 key相同，如果type相同那么复用，如果type不同，那么久不复用。</p><h3 id="状态更新">状态更新</h3><p>可以出发React状态更新的主要有几种方法：ReactDOM.render、this.setState、this.forceUpdate、useState以及useReducer. React通过创建一个Update对象，在render阶段的beginWork中根据这个对象来计算新的state。</p><p>关键节点： 触发状态更新 -&gt; 创建Update对象 -&gt; 从Fiber到root(从触发状态更新的fiber一直向上遍历到rootFiber，并返回rootFiber。) -&gt; 调度更新（Scheduler的工作） -&gt; render阶段 -&gt; commit阶段。</p><p>关于优先级：（具体：<a href="https://react.iamkasong.com/state/priority.html#%E4%BB%80%E4%B9%88%E6%98%AF%E4%BC%98%E5%85%88%E7%BA%A7">React技术揭秘</a>）</p><ul><li>生命周期方法：同步执行。</li><li>受控的用户输入：比如输入框内输入文字，同步执行。</li><li>交互事件：比如动画，高优先级执行。</li><li>其他：比如数据请求，低优先级执行。</li></ul></div><div class="post-tail-wrapper text-muted" id="post-tail-wrapper"><div class="pt-3"> <a href="/tags/%E5%89%8D%E7%AB%AF/" class="post-tag no-text-decoration" >前端</a> <a href="/tags/react/" class="post-tag no-text-decoration" >React</a> <a href="/tags/%E6%BA%90%E7%A0%81/" class="post-tag no-text-decoration" >源码</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center pt-5 pb-2"><div class="license-wrapper"> <span class="license-text ml-1 mr-1"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 <i class="fab fa-creative-commons"></i> <i class="fab fa-creative-commons-by"></i> </a> </span></div><!-- Post sharing snippet v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div class="share-wrapper"> <span class="share-label ml-1 mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=React与它的小伙伴们（1）—— React - Subaru&url=https://mqsh.me/posts/react1/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=React与它的小伙伴们（1）—— React - Subaru&u=https://mqsh.me/posts/react1/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=React与它的小伙伴们（1）—— React - Subaru&url=https://mqsh.me/posts/react1/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><!-- The Pannel on right side (Desktop views) v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="panel-wrapper" class="col-xl-3 pl-2 topbar-down"><div class="access"><div id="access-lastmod" class="post"><h3 data-toc-skip>Recent Update</h3><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Calc/">计算几何专题练习</a></li><li><a href="/posts/People/">独树一帜的「民主」</a></li><li><a href="/posts/algotree/">基础算法与数据结构（二） 树（1）基础二叉树</a></li><li><a href="/posts/tuopu/">基础算法与数据结构（七） 拓扑排序</a></li><li><a href="/posts/biggest/">基础算法与数据结构（十） 最大流最小割</a></li></ul></div><div id="access-tags"><h3 data-toc-skip>Trending Tags</h3><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <!-- The trending tags list v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung MIT Licensed --> <a class="post-tag" href="/tags/新年/">新年</a> <a class="post-tag" href="/tags/年终/">年终</a> <a class="post-tag" href="/tags/图/">图</a> <a class="post-tag" href="/tags/javascript/">JavaScript</a> <a class="post-tag" href="/tags/近代中国/">近代中国</a> <a class="post-tag" href="/tags/读书/">读书</a> <a class="post-tag" href="/tags/历史/">历史</a> <a class="post-tag" href="/tags/react/">React</a> <a class="post-tag" href="/tags/源码/">源码</a> <a class="post-tag" href="/tags/树/">树</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><h3 data-toc-skip class="pl-3 pt-2 mb-3">Contents</h3><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="post-extend-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <!-- Navigation buttons at the bottom of the post. v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --><div class="post-navigation d-flex justify-content-between"> <a href="/posts/abandon/" class="btn btn-outline-primary"><p>放弃的艺术</p></a> <a href="/posts/react2/" class="btn btn-outline-primary"><p>React和它的小伙伴们(2) - Redux与状态管理</p></a></div><!-- The related posts of current post. Placed in the bottom of every single post. v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div id="related-posts" class="mt-4 mb-2 mb-sm-4 pb-2"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/react2/"><div class="card-body"> <span class="timeago small"> Nov 22, 2020 <i class="unloaded">2020-11-22T15:30:36+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>React和它的小伙伴们(2) - Redux与状态管理</h3><div class="text-muted small"><p>Redux 根据前一篇文章中最开始说的，React就是一个函数对应关系，那么相应的，如果作为一个大应用来说就可能有些状态是需要跨组件共用的，那么自然而然地就会想到用一个仓库来把它保存起来，这里就产生了Redux这个“思维模式”。 Redux其实是一个可以脱离React使用的思维模式，这种方式具有四个想法： 提高修改数据（应用状态）的门槛 主要就是引入action和dispatch两个...</p></div></div></a></div><div class="card"> <a href="/posts/react3/"><div class="card-body"> <span class="timeago small"> Jul 10, 2021 <i class="unloaded">2021-07-10T16:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>React和它的小伙伴们(3) - React Hooks</h3><div class="text-muted small"><p>本文为近期有关于React Hooks源码学习的笔记小结，原文对应为： https://juejin.cn/post/6944863057000529933 一 为什么要使用Hooks？ React Hooks是React 16.8中引入的有关于函数组件的相关进化，解决了函数组件没有state、生命周期逻辑不能复用的问题。 引申： Class组件和函数式组件的优缺点 Functio...</p></div></div></a></div><div class="card"> <a href="/posts/busyweektech/"><div class="card-body"> <span class="timeago small"> Dec 12, 2020 <i class="unloaded">2020-12-12T00:30:36+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>忙碌的一周</h3><div class="text-muted small"><p>这一周我度过了可能是入职以来最“忙碌”的一周。一周工时长达了63小时。当然大多数的事情是因为自己在之前完成需求的疏漏，从而产生了如此的结果。这一周还是收获到一些内容的，例如做新需求的时候，学到了一些已经不算新但是好像是第一次付诸实践的东西。 总结一下，以备后查。 React Context 与 Hooks React在几年前引入了新的Context的使用方法，主要的组成部分为生成Cont...</p></div></div></a></div></div></div></div></div></div><script> document.addEventListener('scroll', function(){ let wrapperHeight = $('#post-wrapper').height() - $('#post-tail-wrapper').height(); let nowPosition = $(document).scrollTop(); let now = wrapperHeight !== 0 ? nowPosition / wrapperHeight : 0; $('#progress').attr('style', `width: ${(now * 100)}%`); }); </script> <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const observer = lozad(); observer.observe(); </script> <!-- The Footer v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/mq380">MAO</a>. <span data-toggle="tooltip" data-placement="top" title="The blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank">Jekyll</a> with theme <a href="https://github.com/cotes2020/jekyll-theme-chirpy/">Chirpy</a>.</p></div></div></footer></div><!-- The Search results v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted">Trending Tags</h4><!-- The trending tags list v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung MIT Licensed --> <a class="post-tag" href="/tags/新年/">新年</a> <a class="post-tag" href="/tags/年终/">年终</a> <a class="post-tag" href="/tags/图/">图</a> <a class="post-tag" href="/tags/javascript/">JavaScript</a> <a class="post-tag" href="/tags/近代中国/">近代中国</a> <a class="post-tag" href="/tags/读书/">读书</a> <a class="post-tag" href="/tags/历史/">历史</a> <a class="post-tag" href="/tags/react/">React</a> <a class="post-tag" href="/tags/源码/">源码</a> <a class="post-tag" href="/tags/树/">树</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <!-- The GA snippet v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-74221043-1', 'auto'); ga('send', 'pageview'); </script> <!-- Jekyll Simple Search loader v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js" integrity="sha256-qcLR00zq6pJk4je3MLgAri8Nn+ZumUlXgTKR2H/xCY0=" crossorigin="anonymous"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://mqsh.me{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
